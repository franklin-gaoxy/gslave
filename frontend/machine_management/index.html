<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>机器管理 - GSlave</title>
  <style>
    :root { --brand:#111827; --bg:#f5f7fa; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb; --btn:#2563eb; --btnText:#fff; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:var(--text); }
    .header { height:56px; display:flex; align-items:center; padding:0 16px; background:#fff; border-bottom:1px solid var(--border); position:sticky; top:0; z-index:10; }
    .brand { font-weight:700; color:var(--brand); letter-spacing:.2px; margin-right:12px; }
    .head-left { display:flex; gap:8px; align-items:center; }
    .spacer { flex:1; }
    .head-right { display:flex; gap:8px; align-items:center; }
    .layout { display:flex; min-height: calc(100vh - 56px); }
    .sidebar { width:220px; background:#fff; border-right:1px solid var(--border); }
    .sidebar .section { padding:12px; color:var(--muted); font-size:13px; border-bottom:1px solid var(--border); }
    .sidebar .list { padding:12px; display:flex; flex-direction:column; gap:8px; }
    .content { flex:1; padding:20px; }
    .card { background:#fff; border:1px solid var(--border); border-radius:12px; padding:24px; box-shadow:0 8px 24px rgba(0,0,0,.04); }
    .toolbar { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
    .input { padding:8px 10px; border:1px solid var(--border); border-radius:8px; font-size:13px; }
    .input.naked { border:none; background:transparent; padding:0; }
    .toolbar .input { min-width:240px; flex:0 1 240px; }
    .card table .input { width:100%; min-width:0; }
    .select { padding:8px 10px; border:1px solid var(--border); border-radius:8px; font-size:13px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid var(--border); padding:10px; text-align:left; font-size:13px; }
    th { color:var(--muted); font-weight:600; }
    .row-actions { display:inline-flex; flex-direction:row; gap:8px; align-items:center; white-space:nowrap; }
    .mark-ok { color:#10b981; margin-left:6px; font-weight:700; }
    .mark-fail { color:#ef4444; margin-left:6px; font-weight:700; }
    .btn-mini { height:24px; padding:0 8px; font-size:12px; }
    .pagination { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
    .manage-bar { display:flex; justify-content:flex-end; margin-top:12px; }
    .tag-link { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#fff; color:#2563eb; border:1px solid var(--border); text-decoration:none; margin-right:6px; }
    .tag-link:hover { background:#f0f7ff; }
    .tags-wrap { display:flex; flex-wrap:wrap; gap:6px; align-items:center; min-height:22px; }
    .btn { display:inline-flex; align-items:center; gap:6px; height:30px; padding:0 12px; border-radius:8px; background:var(--btn); color:var(--btnText); text-decoration:none; font-size:13px; }
    .btn.secondary { background:#fff; color:var(--text); border:1px solid var(--border); }
    .btn-head { display:inline-flex; align-items:center; gap:8px; padding:0 10px; margin:0 6px; background:transparent; border:none; color:var(--brand); text-decoration:none; font-size:15px; font-weight:600; }
    .btn-green { background:#10b981; color:#fff; }
    .modal-mask { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; }
    .modal { width:720px; max-width:90vw; background:#fff; border-radius:12px; box-shadow:0 12px 36px rgba(0,0,0,.2); padding:20px; }
    .modal .row { display:flex; gap:12px; margin:10px 0; }
    .modal label { width:100px; color:var(--muted); font-size:13px; align-self:center; }
    .modal input { flex:1; padding:8px 10px; border:1px solid var(--border); border-radius:8px; font-size:13px; }
    .modal textarea { flex:1; padding:8px 10px; border:1px solid var(--border); border-radius:8px; font-size:13px; }
    .modal .actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
    .tag-pop { position:absolute; left:0; background:#fff; border:1px solid var(--border); border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,.08); padding:6px; max-height:180px; overflow:auto; min-width:220px; display:none; z-index:1000; }
    .tag-item { padding:6px 8px; cursor:pointer; border-radius:6px; }
    .tag-item:hover { background:#f0f7ff; }
    .arrow { position:absolute; right:6px; top:50%; transform:translateY(-50%); background:transparent; border:0; color:var(--muted); height:24px; width:24px; cursor:pointer; }
  </style>
</head>
<body>
  <div class="header">
    <div class="brand">GSlave</div>
    <div id="head-left" class="head-left"></div>
    <div class="spacer"></div>
    <div id="head-right" class="head-right"></div>
  </div>
  <div class="layout">
    <aside class="sidebar" aria-label="侧边栏">
      <div class="section">导航</div>
      <div id="side" class="list"></div>
    </aside>
    <main class="content">
      <div class="card">
        <div class="toolbar">
          <input id="searchBox" class="input" placeholder="搜索内容">
          <select id="fieldSelect" class="select">
            <option value="name">名称</option>
            <option value="ip">IP</option>
            <option value="tag">标签</option>
          </select>
          <button id="filterBtn" class="btn">筛选</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>名称</th><th>IP</th><th>CPU</th><th>内存</th><th>硬盘</th><th>数据盘</th><th>描述</th><th>标签</th><th>操作</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div class="pagination">
          <button id="prev" class="btn secondary">上一页</button>
          <div id="pageInfo" style="align-self:center; color:var(--muted);"></div>
          <button id="next" class="btn secondary">下一页</button>
        </div>
        <div class="manage-bar">
          <button id="manage" class="btn">管理</button>
          <button id="addMachine" class="btn btn-green" type="button" style="display:none;">添加</button>
        </div>
      </div>
    </main>
    <div id="modalMask" class="modal-mask">
      <div class="modal">
        <div style="font-weight:600; margin-bottom:8px;">添加机器</div>
        <div class="row"><label>名称</label><input id="mName" placeholder="名称"></div>
        <div class="row"><label>IP / 端口</label>
          <input id="mIP" placeholder="IP" style="flex:3;">
          <input id="mPort" placeholder="端口" style="flex:1; max-width:140px;">
        </div>
        <div class="row"><label>用户名</label><input id="mUser" placeholder="用户名"></div>
        <div class="row"><label>密码</label><input id="mPass" placeholder="密码" type="password"></div>
        <div class="row"><label>密钥</label><textarea id="mKey" placeholder="密钥" style="min-width:520px; height:108px;"></textarea></div>
        <div class="row" id="tagRow" style="position:relative; align-items:center;">
          <label>标签</label>
          <div style="flex:1 1 auto; position:relative;">
            <input id="mTagInput" class="input" placeholder="输入或选择标签" style="width:100%; padding-right:32px;">
            <button id="mTagArrow" class="arrow" type="button">▾</button>
            <div id="mTagPop" class="tag-pop"></div>
          </div>
          <button id="addModalTag" class="btn secondary" type="button">添加</button>
        </div>
        <div class="row"><label></label><div id="modalTags" class="tags-wrap" style="flex:1;"></div></div>
        <div class="actions">
          <button id="cancelAdd" class="btn secondary" type="button">取消</button>
          <button id="confirmAdd" class="btn btn-green" type="button">添加</button>
        </div>
      </div>
    </div>
  </div>
  <div id="toast" style="position:fixed; top:8px; left:50%; transform:translateX(-50%); background:#10b981; color:#fff; padding:8px 14px; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,.15); display:none; z-index:1200;">添加成功</div>
  <script>
    function el(tag, attrs, text){ const e=document.createElement(tag); if(attrs) Object.assign(e, attrs); if(text) e.textContent=text; return e; }
    function renderButtons(items){
      const headLeft=document.getElementById('head-left');
      const headRight=document.getElementById('head-right');
      const side=document.getElementById('side');
      headLeft.innerHTML=''; headRight.innerHTML=''; side.innerHTML='';
      items.forEach(it=>{
        if(it.type==='head'){
          const a=el('a',{href:it.address,className:'btn-head'},it.name);
          headLeft.appendChild(a);
        } else if(it.type==='head-end'){
          const a=el('a',{href:it.address,className:'btn'},it.name);
          headRight.appendChild(a);
        } else {
          const a=el('a',{href:it.address,className:'btn secondary'},it.name);
          side.appendChild(a);
        }
      });
    }
    async function loadButtons(){
      try {
        const res = await fetch('/api/homepage_button');
        if(res.status===401){ location.assign('/login/'); return; }
        if(!res.ok) return;
        const data = await res.json();
        renderButtons(data||[]);
      } catch (e) {}
    }
    document.addEventListener('DOMContentLoaded', loadButtons);
    let page=1, pageSize=10, total=0, edit=false, currentTag='', queryText='', queryField='';
    async function loadMachines(){
      const qs = new URLSearchParams({ page: String(page), pageSize: String(pageSize) });
      if(currentTag) qs.set('tag', currentTag);
      if(queryText) qs.set('q', queryText);
      if(queryField) qs.set('qField', queryField);
      const res = await fetch('/api/machines?'+qs.toString());
      if(res.status===401){ location.assign('/login/'); return; }
      if(!res.ok) return;
      const data = await res.json();
      total = data.total || 0;
      renderTable(data.items||[]);
      document.getElementById('pageInfo').textContent = `第 ${page} 页 / 共 ${Math.ceil(total/pageSize)||1} 页`;
    }
    function chip(tag){
      const a=el('a',{href:'#', className:'tag-link'}, tag);
      a.addEventListener('click', (e)=>{ e.preventDefault(); currentTag = tag; document.getElementById('searchBox').value = tag; queryText = tag; document.getElementById('fieldSelect').value = 'tag'; queryField='tag'; page=1; loadMachines(); });
      return a;
    }
    function renderTable(items){
      const tbody = document.getElementById('tbody');
      tbody.innerHTML='';
      items.forEach(it=>{
        const tr = document.createElement('tr');
        tr.dataset.id = it.id || '';
        const tdName = document.createElement('td');
        const tdIP = document.createElement('td');
        const tdCPU = document.createElement('td');
        const tdMem = document.createElement('td');
        const tdDisk = document.createElement('td');
        const tdDataDisk = document.createElement('td');
        const tdDesc = document.createElement('td');
        const tdTags = document.createElement('td');
        const tdOps = document.createElement('td');
        if(edit){
          tdName.textContent=it.name; tdIP.textContent=it.ip; tdCPU.textContent=it.cpu; tdMem.textContent=it.memory; tdDisk.textContent=it.disk; tdDataDisk.textContent=it.dataDisk; tdDesc.textContent=it.description;
          const tagBox=document.createElement('div'); tagBox.className='tags-wrap';
          const tagsArr = Array.isArray(it.tags) ? it.tags : [];
          if(tagsArr.length===0){ tagBox.textContent='—'; }
          tagsArr.forEach(t=> tagBox.appendChild(chip(t)) );
          tdTags.appendChild(tagBox);
          const ops=document.createElement('div'); ops.className='row-actions';
          const editBtn=el('button',{className:'btn', type:'button'},'修改');
          editBtn.addEventListener('click', async ()=>{
            const mask=document.getElementById('modalMask');
            document.querySelector('#modalMask .modal div').textContent='修改机器';
            let detail = it;
            try {
              const res = await fetch('/api/machines_one?id='+(it.id||'')+'&includeCreds=true');
              if(res.ok){ detail = await res.json(); }
            } catch (e) {}
            document.getElementById('mName').value = detail.name || '';
            document.getElementById('mIP').value = detail.ip || '';
            document.getElementById('mPort').value = detail.port || '';
            document.getElementById('mUser').value = detail.username || '';
            document.getElementById('mPass').value = detail.password || '';
            document.getElementById('mKey').value = detail.key || '';
            const box=document.getElementById('modalTags'); box.innerHTML='';
            const tags = Array.isArray(detail.tags) ? detail.tags : [];
            tags.forEach(t=> addModalTagToList(t));
            const okBtn=document.getElementById('confirmAdd');
            okBtn.textContent='保存';
            okBtn.dataset.mode='edit';
            okBtn.dataset.id = it.id || '';
            mask.style.display='flex';
          });
          const delBtn=el('button',{className:'btn secondary', type:'button'},'删除');
          delBtn.addEventListener('click', async ()=>{
            const res = await fetch('/api/machines',{ method:'DELETE', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id: it.id })});
            if(res.status===401){ location.assign('/login/'); return; }
            if(res.ok){ await loadMachines(); }
          });
          ops.appendChild(editBtn); ops.appendChild(delBtn); tdOps.appendChild(ops);
        } else {
          tdName.textContent=it.name; tdIP.textContent=it.ip; tdCPU.textContent=it.cpu; tdMem.textContent=it.memory; tdDisk.textContent=it.disk; tdDataDisk.textContent=it.dataDisk; tdDesc.textContent=it.description;
          const tagBox=document.createElement('div'); tagBox.className='tags-wrap';
          const tagsArr = Array.isArray(it.tags) ? it.tags : [];
          if(tagsArr.length===0){ tagBox.textContent='—'; }
          tagsArr.forEach(t=> tagBox.appendChild(chip(t)) );
          tdTags.appendChild(tagBox);
          const ops=document.createElement('div'); ops.className='row-actions';
          const linkBtn=el('button',{className:'btn secondary btn-mini', type:'button'},'链接测试');
          linkBtn.addEventListener('click', async ()=>{
            let detail = it;
            try {
              const res = await fetch('/api/machines_one?id='+(it.id||'')+'&includeCreds=true');
              if(res.status===401){ location.assign('/login/'); return; }
              if(res.ok){ detail = await res.json(); }
            } catch (e) {}
            const payload={ id: detail.id, ip: detail.ip, port: detail.port||'22', username: detail.username||'', password: detail.password||'', key: detail.key||'' };
            const res=await fetch('/api/machines/test_connect',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
            if(res.status===401){ location.assign('/login/'); return; }
            let ok=false, errMsg='';
            if(res.ok){ const data=await res.json().catch(()=>({})); ok=!!data.ok; errMsg = data.error || '';
            } else {
              const data=await res.json().catch(()=>({})); ok=false; errMsg = (data && data.error) || '';
            }
            Array.from(linkBtn.querySelectorAll('.mark-ok,.mark-fail')).forEach(x=>x.remove());
            const mark=document.createElement('span'); mark.className= ok ? 'mark-ok' : 'mark-fail'; mark.textContent= ok ? '✓' : '✗'; linkBtn.appendChild(mark);
            if(!ok){ showError('连接测试失败', errMsg || '连接失败'); }
          });
          const infoBtn=el('button',{className:'btn secondary btn-mini', type:'button'},'信息读取');
          infoBtn.addEventListener('click', async ()=>{
            let detail = it;
            try {
              const res = await fetch('/api/machines_one?id='+(it.id||'')+'&includeCreds=true');
              if(res.status===401){ location.assign('/login/'); return; }
              if(res.ok){ detail = await res.json(); }
            } catch (e) {}
            const payload={ id: detail.id, ip: detail.ip, port: detail.port||'22', username: detail.username||'', password: detail.password||'', key: detail.key||'' };
            const res=await fetch('/api/machines/read_info',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
            let ok=false; if(res.ok){ const data=await res.json().catch(()=>({})); ok=!!data.ok; }
            Array.from(infoBtn.querySelectorAll('.mark-ok,.mark-fail')).forEach(x=>x.remove());
            const mark=document.createElement('span'); mark.className= ok ? 'mark-ok' : 'mark-fail'; mark.textContent= ok ? '✓' : '✗'; infoBtn.appendChild(mark);
            if(ok){ await loadMachines(); }
          });
          const initBtn=el('button',{className:'btn secondary btn-mini', type:'button'},'机器初始化');
          initBtn.addEventListener('click', async ()=>{
            let detail = it;
            try {
              const res = await fetch('/api/machines_one?id='+(it.id||'')+'&includeCreds=true');
              if(res.status===401){ location.assign('/login/'); return; }
              if(res.ok){ detail = await res.json(); }
            } catch (e) {}
            const payload={ id: detail.id, ip: detail.ip, port: detail.port||'22', username: detail.username||'', password: detail.password||'', key: detail.key||'' };
            const res=await fetch('/api/machines/init',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
            let ok=false; if(res.ok){ const data=await res.json().catch(()=>({})); ok=!!data.ok; }
            Array.from(initBtn.querySelectorAll('.mark-ok,.mark-fail')).forEach(x=>x.remove());
            const mark=document.createElement('span'); mark.className= ok ? 'mark-ok' : 'mark-fail'; mark.textContent= ok ? '✓' : '✗'; initBtn.appendChild(mark);
          });
          ops.appendChild(linkBtn); ops.appendChild(infoBtn); ops.appendChild(initBtn); tdOps.appendChild(ops);
        }
        tr.appendChild(tdName); tr.appendChild(tdIP); tr.appendChild(tdCPU); tr.appendChild(tdMem); tr.appendChild(tdDisk); tr.appendChild(tdDataDisk); tr.appendChild(tdDesc); tr.appendChild(tdTags); tr.appendChild(tdOps);
        tbody.appendChild(tr);
      });
    }
    document.getElementById('prev').addEventListener('click', ()=>{ if(page>1){ page--; loadMachines(); } });
    document.getElementById('next').addEventListener('click', ()=>{ const max=Math.ceil(total/pageSize)||1; if(page<max){ page++; loadMachines(); } });
    document.getElementById('filterBtn').addEventListener('click', ()=>{ queryText = document.getElementById('searchBox').value.trim(); queryField = document.getElementById('fieldSelect').value; page=1; loadMachines(); });
    document.getElementById('searchBox').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ queryText = document.getElementById('searchBox').value.trim(); queryField = document.getElementById('fieldSelect').value; page=1; loadMachines(); } });
    const manageBtn = document.getElementById('manage');
    const addBtn = document.getElementById('addMachine');
    manageBtn.addEventListener('click', async ()=>{
      if(!edit){
        edit = true;
        manageBtn.textContent = '退出管理';
        addBtn.style.display = '';
        loadMachines();
        return;
      }
      edit = false;
      manageBtn.textContent = '管理';
      addBtn.style.display = 'none';
      loadMachines();
    });
    document.getElementById('addMachine').addEventListener('click', ()=>{
      const mask=document.getElementById('modalMask');
      document.querySelector('#modalMask .modal div').textContent='添加机器';
      document.getElementById('mName').value='';
      document.getElementById('mIP').value='';
      document.getElementById('mPort').value='';
      document.getElementById('mUser').value='';
      document.getElementById('mPass').value='';
      document.getElementById('mKey').value='';
      document.getElementById('modalTags').innerHTML='';
      const okBtn=document.getElementById('confirmAdd');
      okBtn.textContent='添加';
      okBtn.dataset.mode='add';
      okBtn.dataset.id='';
      mask.style.display='flex';
    });
    document.getElementById('cancelAdd').addEventListener('click', ()=>{ const okBtn=document.getElementById('confirmAdd'); okBtn.textContent='添加'; okBtn.dataset.mode='add'; okBtn.dataset.id=''; document.getElementById('modalMask').style.display='none'; });
    document.getElementById('confirmAdd').addEventListener('click', async ()=>{
      const name = document.getElementById('mName').value.trim();
      const ip = document.getElementById('mIP').value.trim();
      const port = document.getElementById('mPort').value.trim();
      const username = document.getElementById('mUser').value.trim();
      const password = document.getElementById('mPass').value.trim();
      const key = document.getElementById('mKey').value.trim();
      const tags = Array.from(document.querySelectorAll('#modalTags .tag-link')).map(x=>x.textContent).filter(Boolean);
      if(!name || !ip){ return; }
      const okBtn=document.getElementById('confirmAdd');
      if(okBtn.dataset.mode==='edit'){
        const id = okBtn.dataset.id || '';
        const res = await fetch('/api/machines',{ method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id, name, ip, port, username, password, key, tags })});
        if(res.status===401){ location.assign('/login/'); return; }
        if(res.ok){
          document.getElementById('modalMask').style.display='none';
          okBtn.textContent='添加'; okBtn.dataset.mode='add'; okBtn.dataset.id='';
          const toast=document.getElementById('toast'); toast.textContent='保存成功'; toast.style.display='block'; setTimeout(()=>{ toast.style.display='none'; }, 5000);
          await loadMachines();
        } else {
          const data = await res.json().catch(()=>({}));
          showError('保存失败', (data && data.error) || '');
        }
        return;
      }
      const res = await fetch('/api/machines',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, ip, port, username, password, key, tags })});
      if(res.status===401){ location.assign('/login/'); return; }
      if(res.ok){
        document.getElementById('modalMask').style.display='none';
        const toast=document.getElementById('toast'); toast.textContent='添加成功'; toast.style.display='block'; setTimeout(()=>{ toast.style.display='none'; }, 5000);
        await loadMachines();
      } else {
        const data = await res.json().catch(()=>({}));
        showError('添加失败', (data && data.error) || '');
      }
    });
    // simple error modal
    function showError(title,msg){
      let mask=document.getElementById('errorMask');
      if(!mask){
        mask=document.createElement('div'); mask.id='errorMask'; mask.style.position='fixed'; mask.style.inset='0'; mask.style.background='rgba(0,0,0,.35)'; mask.style.display='flex'; mask.style.alignItems='center'; mask.style.justifyContent='center'; mask.style.zIndex='1300';
        const box=document.createElement('div'); box.style.background='#fff'; box.style.borderRadius='12px'; box.style.boxShadow='0 12px 36px rgba(0,0,0,.2)'; box.style.padding='20px'; box.style.minWidth='280px';
        const t=document.createElement('div'); t.id='errorTitle'; t.style.fontWeight='600'; t.style.marginBottom='8px'; box.appendChild(t);
        const content=document.createElement('div'); content.id='errorContent'; content.style.color='#ef4444'; content.style.marginBottom='12px'; box.appendChild(content);
        const btn=document.createElement('button'); btn.textContent='关闭'; btn.className='btn'; btn.addEventListener('click', ()=>{ mask.style.display='none'; }); box.appendChild(btn);
        mask.appendChild(box); document.body.appendChild(mask);
      }
      document.getElementById('errorTitle').textContent = title || '错误';
      document.getElementById('errorContent').textContent = msg || '';
      mask.style.display='flex';
    }
    // modal tag dropdown logic
    let allTagsModal=[];
    async function ensureModalTags(){ if(allTagsModal.length) return; const res=await fetch('/api/machines/tags'); if(res.ok){ const data=await res.json(); allTagsModal=(data.items||[]); } }
    function renderModalPop(){ const input=document.getElementById('mTagInput'); const pop=document.getElementById('mTagPop'); const q=input.value.trim().toLowerCase(); pop.innerHTML=''; const list=(allTagsModal||[]).filter(t=>!q || t.toLowerCase().includes(q)); list.forEach(t=>{ const item=document.createElement('div'); item.className='tag-item'; item.textContent=t; item.addEventListener('click', ()=>{ addModalTagToList(t); pop.style.display='none'; }); pop.appendChild(item); }); }
    function addModalTagToList(tag){ const box=document.getElementById('modalTags'); const a=document.createElement('a'); a.className='tag-link'; a.href='#'; a.textContent=tag; a.addEventListener('click', (e)=>{ e.preventDefault(); a.remove(); }); box.appendChild(a); }
    document.getElementById('mTagArrow').addEventListener('click', async ()=>{ const input=document.getElementById('mTagInput'); const pop=document.getElementById('mTagPop'); await ensureModalTags(); renderModalPop(); pop.style.minWidth = input.offsetWidth+"px"; pop.style.left = input.offsetLeft+"px"; pop.style.top = (input.offsetTop + input.offsetHeight + 4)+"px"; pop.style.display= pop.style.display==='none' || !pop.style.display ? 'block' : 'none'; });
    document.getElementById('mTagInput').addEventListener('input', ()=>{ const pop=document.getElementById('mTagPop'); if(pop.style.display==='block'){ renderModalPop(); } });
    document.getElementById('addModalTag').addEventListener('click', ()=>{ const v=document.getElementById('mTagInput').value.trim(); if(!v) return; addModalTagToList(v); document.getElementById('mTagInput').value=''; });
    document.addEventListener('DOMContentLoaded', loadMachines);
  </script>
</body>
</html>
