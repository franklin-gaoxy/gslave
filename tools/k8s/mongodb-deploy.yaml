# 3. ConfigMap：MongoDB配置文件
apiVersion: v1
kind: ConfigMap
metadata:
  name: mongo-config
  labels:
    app: mongo
data:
  mongod.conf: |
    systemLog:
      destination: file
      path: /var/log/mongodb/mongod.log
      logAppend: true
    storage:
      dbPath: /data/db
      engine: wiredTiger
      wiredTiger:
        engineConfig:
          cacheSizeGB: 1
    net:
      port: 27017
      bindIp: 0.0.0.0
    security:
      authorization: enabled
    processManagement:
      fork: false
---
# 4. Deployment：MongoDB部署（default命名空间）
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mongo
  labels:
    app: mongo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mongo
  template:
    metadata:
      labels:
        app: mongo
    spec:
      # Pod级安全上下文：设置文件系统组权限
      securityContext:
        fsGroup: 999
      containers:
      - name: mongo
        image: mongo:7.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 27017
          name: mongo-port
        # 初始化管理员账号密码
        env:
        - name: MONGO_INITDB_ROOT_USERNAME
          value: "root"
        - name: MONGO_INITDB_ROOT_PASSWORD
          value: "Mongo@123456"
        # 挂载配置、数据、日志目录
        volumeMounts:
        - name: mongo-config-volume
          mountPath: /etc/mongod.conf.d/
        - name: mongo-data-volume
          mountPath: /data/db  # 容器内数据目录，绑定到本地路径
        - name: mongo-log-volume
          mountPath: /var/log/mongodb
        # 容器级安全上下文：以mongodb用户运行
        securityContext:
          runAsUser: 999
          runAsGroup: 999
      # 定义卷
      volumes:
      - name: mongo-config-volume
        configMap:
          name: mongo-config
      - name: mongo-data-volume
        hostPath:
          path: /Users/bytedance/docker/mongodb
          type: DirectoryOrCreate
      - name: mongo-log-volume
        emptyDir: {}
---
# 5. Service：暴露MongoDB服务（default命名空间）
apiVersion: v1
kind: Service
metadata:
  name: mongo-service
  labels:
    app: mongo
spec:
  type: NodePort  # 如需外部访问改为NodePort
  selector:
    app: mongo
  ports:
  - port: 27017
    targetPort: mongo-port
    protocol: TCP
    name: mongo-port
    nodePort: 30017
